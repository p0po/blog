<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="alternative" href="/atom.xml" title="p0po's blog" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>排行榜技术记录 - p0po's blog</title><link rel="stylesheet" href="/css/main.css" type="text/css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--></head><body><header class="head"><h1 class="head-title u-fl"><a href="/">p0po's blog</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a href="/" class="head-nav__link">Home</a></li><li class="head-nav__item"><a href="/archives" class="head-nav__link">Archives</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><time datetime="2017-07-01T16:58:06.000Z" class="post__time">July 2, 2017</time><h1 class="post__title"><a href="/2017/07/02/排行榜技术记录/">排行榜技术记录</a></h1></header><div class="post__main echo"><p>排行榜一般都是异步任务跑出结果，将结果放入缓存，比如redis，然后将缓存中的结果展示给用户。<br>一般来说，大家都能想到这个方案，但是很多在展示的排行榜都忽略了一个要素，那就是排行榜生成时间，<br>对于异步生成的排行榜来说，这个至关重要，因为从严谨性考虑，应该给用户交代清楚，这个结果的有效时间范围。</p>
<h2 id="排行榜需求是统计用户投资前100名。">排行榜需求是统计用户投资前100名。</h2><h3 id="开始为了完成功能：">开始为了完成功能：</h3><p>在数据量少的时候，直接SQL统计结果出来，放到REDIS中，很简单，也很有效。</p>
<h3 id="但随着数据量的增加，一个SQL肯定会越来越慢：">但随着数据量的增加，一个SQL肯定会越来越慢：</h3><p>于是想到分页查询，在内存中统计结果，然后将结果放入到REDIS中，效果也还不错。</p>
<h3 id="随着数据量的增加，每次统计IO越来越大，时间越来越长：">随着数据量的增加，每次统计IO越来越大，时间越来越长：</h3><p>于是想到将查询到结果缓存到本地内存中，缓存中没有才去数据库查询，然后将其缓存到本地，即减少了和数据库的交互次数，又减少了每次统计时间，可以继续运转了。</p>
<h3 id="随着数据量的增加，本地内存开始出现溢出告警，对于java程序来说，经常出现FULL_GC：">随着数据量的增加，本地内存开始出现溢出告警，对于java程序来说，经常出现FULL GC：</h3><p>于是将每个用户的投资总额放到redis，标记每次查询的时间，下次增量查询计算相关用户的投资总额，并改写用户在redis中的投资总额，<br>将每个用户的投资总额和排行榜中的最小值做比较，如果大于最小值，则放入排行榜，删除原来的最小值。</p>
<h3 id="随着数据量的增加，没有出现什么大的问题，但上述方案存在隐患，后续验证后会补上。">随着数据量的增加，没有出现什么大的问题，但上述方案存在隐患，后续验证后会补上。</h3></div><footer class="post__foot u-cf"><a href="/2017/07/02/排行榜技术记录/#disqus_thread" class="post__foot-link u-fr">0 COMMENTS</a></footer></article></main><footer class="foot"><div class="foot-copy u-fl">&copy; 2017 p0po</div><menu class="page-menu u-fr"><li class="page-menu__item"><span title="Previous" class="page-menu__link icon-arrow-left page-menu__link--disabled"></span></li><li class="page-menu__item"><a title="Next" href="/2017/01/21/hello-world/" class="page-menu__link icon-arrow-right"></a></li></menu></footer></body></html>